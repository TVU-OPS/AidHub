[{"name":"/#Logic/GetDisasters","nodes":[{"id":"d53744f0-d859-970c-8efb-458658cc23e9","type":"/#Logic/Environment","parameters":{},"ports":[],"children":[]},{"id":"210b3e3a-b1fe-b1da-1058-3c623aede2bd","type":"REST2","parameters":{"responseScript":"// Add custom code to convert the response content to outputs\n//\n//*Response.status    The status code of the response\n//*Response.content   The content of the response as a javascript\n//                    object.\n//*Response.request   The request object that resulted in the response.\n//\n//*Inputs and *Outputs contain the inputs and outputs of the node.\n\nconst DATA = Response.content;\n\nif(!DATA) return;\n\nOutputs.Pagination = Response.content?.meta?.pagination\nOutputs.DATA = Response.content?.data\nOutputs.Results = Response.DATA;"},"ports":[],"children":[]},{"id":"fc48e18e-8803-1f0f-c228-697664bcc5be","type":"JavaScriptFunction","parameters":{"functionScript":"const page = Inputs.page + 1 || 1;\r\nconst pageSize = Inputs.pageSize || 5;\r\nconst base_url = Inputs.base_url;\r\n\r\nconst keyword = Inputs.keyword;\r\nconst sort = Inputs.sort || \"desc\";\r\nconst status = Inputs.status;\r\nconst type = Inputs.type;\r\nconst provinceId = Inputs.provinceId;\r\nconst districtId = Inputs.districtId;\r\nconst wardId = Inputs.wardId;\r\nconst disasterId = Inputs.disasterId;\r\n\r\nfunction createFilters(keyword) {\r\n  if (!keyword || typeof keyword !== \"string\") {\r\n    throw new Error(\"Keyword không hợp lệ!\");\r\n  }\r\n\r\n  const filters = [\r\n    `filters[$or][0][Name][$contains]=${keyword}`, // Tìm theo trường Name\r\n    `filters[$or][1][Description][$contains]=${keyword}`, // Tìm trong User.username\r\n    `filters[$or][2][DisasterType][DisasterTypeName][$contains]=${keyword}`, // Tìm trong User.username\r\n  ];\r\n\r\n  return `${filters.join(\"&\")}`;\r\n}\r\n\r\nlet api = ``;\r\n\r\nif(disasterId) {\r\n  api = `${base_url}/disasters/${disasterId}?populate=*`\r\n}\r\nelse {\r\n  api = `${base_url}/disasters?populate=*&pagination[page]=${page}&pagination[pageSize]=${pageSize}&sort=createdAt:${sort}`;\r\n}\r\n\r\nif (keyword) {\r\n  const apiEndpoint = keyword && createFilters(keyword);\r\n  api += `&${apiEndpoint}`;\r\n}\r\n\r\nif (status) {\r\n  let filters = [];\r\n  // Chưa diễn ra\r\n  if (status == \"1\") {\r\n    filters = [`filters[StartDate][$gt]=${new Date().toISOString()}`];\r\n  }\r\n\r\n  // Đang diễn ra\r\n  if (status == \"2\") {\r\n    filters = [\r\n      `filters[StartDate][$lte]=${new Date().toISOString()}`,\r\n      `filters[$or][0][EndDate][$null]=true`,\r\n      `filters[$or][1][EndDate][$gte]=${new Date().toISOString()}`,\r\n    ];\r\n  }\r\n\r\n  // Đã diễn ra\r\n  if (status == \"3\") {\r\n    filters= [\r\n        `filters[EndDate][$lt]=${new Date().toISOString()}`\r\n    ]\r\n  }\r\n\r\n  api += `&${filters.join(\"&\")}`;\r\n}\r\n\r\nif(provinceId){\r\n  api += `&filters[Provinces]=${provinceId}`\r\n}\r\n\r\nif(districtId){\r\n  api += `&filters[Districts]=${districtId}`\r\n}\r\n\r\nif(wardId){\r\n  api += `&filters[Provinces]=${wardId}`\r\n}\r\n\r\nif(type){\r\n  api += `&filters[Wards]=${type}`\r\n}\r\n\r\n\r\nOutputs.api = api;\r\n"},"ports":[{"name":"in-page","displayName":"page","plug":"input","type":"*","group":"Inputs","index":4},{"name":"in-pageSize","displayName":"pageSize","plug":"input","type":"*","group":"Inputs","index":5},{"name":"in-base_url","displayName":"base_url","plug":"input","type":"*","group":"Inputs","index":6},{"name":"in-keyword","displayName":"keyword","plug":"input","type":"*","group":"Inputs","index":7},{"name":"in-sort","displayName":"sort","plug":"input","type":"*","group":"Inputs","index":8},{"name":"in-status","displayName":"status","plug":"input","type":"*","group":"Inputs","index":9},{"name":"in-type","displayName":"type","plug":"input","type":"*","group":"Inputs","index":10},{"name":"in-provinceId","displayName":"provinceId","plug":"input","type":"*","group":"Inputs","index":11},{"name":"in-districtId","displayName":"districtId","plug":"input","type":"*","group":"Inputs","index":12},{"name":"in-wardId","displayName":"wardId","plug":"input","type":"*","group":"Inputs","index":13},{"name":"in-disasterId","displayName":"disasterId","plug":"input","type":"*","group":"Inputs","index":14},{"name":"out-api","displayName":"api","plug":"output","type":"*","group":"Outputs","index":15}],"children":[]},{"id":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","type":"Component Inputs","parameters":{},"ports":[],"children":[]},{"id":"6fc2a588-0cc4-fd30-be1c-a3f3b52ba078","type":"Component Outputs","parameters":{},"ports":[],"children":[]},{"id":"e129ce2e-bf7a-9255-9066-102fb4e6ec95","type":"/Components/Loading Spinner","parameters":{},"ports":[],"children":[]},{"id":"c388a816-8daf-0c6a-129a-96c7775d506b","type":"/#Logic/GetPaganation","parameters":{},"ports":[],"children":[]}],"connections":[{"sourceId":"fc48e18e-8803-1f0f-c228-697664bcc5be","sourcePort":"out-api","targetId":"210b3e3a-b1fe-b1da-1058-3c623aede2bd","targetPort":"resource"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"page","targetId":"fc48e18e-8803-1f0f-c228-697664bcc5be","targetPort":"in-page"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"limit","targetId":"fc48e18e-8803-1f0f-c228-697664bcc5be","targetPort":"in-pageSize"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"keyword","targetId":"fc48e18e-8803-1f0f-c228-697664bcc5be","targetPort":"in-keyword"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"sort","targetId":"fc48e18e-8803-1f0f-c228-697664bcc5be","targetPort":"in-sort"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"status","targetId":"fc48e18e-8803-1f0f-c228-697664bcc5be","targetPort":"in-status"},{"sourceId":"210b3e3a-b1fe-b1da-1058-3c623aede2bd","sourcePort":"out-DATA","targetId":"6fc2a588-0cc4-fd30-be1c-a3f3b52ba078","targetPort":"Data"},{"sourceId":"210b3e3a-b1fe-b1da-1058-3c623aede2bd","sourcePort":"success","targetId":"6fc2a588-0cc4-fd30-be1c-a3f3b52ba078","targetPort":"Success"},{"sourceId":"210b3e3a-b1fe-b1da-1058-3c623aede2bd","sourcePort":"failure","targetId":"6fc2a588-0cc4-fd30-be1c-a3f3b52ba078","targetPort":"Failure"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"Do","targetId":"210b3e3a-b1fe-b1da-1058-3c623aede2bd","targetPort":"fetch"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"type","targetId":"fc48e18e-8803-1f0f-c228-697664bcc5be","targetPort":"in-type"},{"sourceId":"d53744f0-d859-970c-8efb-458658cc23e9","sourcePort":"API_URL","targetId":"fc48e18e-8803-1f0f-c228-697664bcc5be","targetPort":"in-base_url"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"Do","targetId":"e129ce2e-bf7a-9255-9066-102fb4e6ec95","targetPort":"Show"},{"sourceId":"e129ce2e-bf7a-9255-9066-102fb4e6ec95","sourcePort":"Done","targetId":"210b3e3a-b1fe-b1da-1058-3c623aede2bd","targetPort":"fetch"},{"sourceId":"210b3e3a-b1fe-b1da-1058-3c623aede2bd","sourcePort":"out-Pagination","targetId":"c388a816-8daf-0c6a-129a-96c7775d506b","targetPort":"Pagination"},{"sourceId":"c388a816-8daf-0c6a-129a-96c7775d506b","sourcePort":"page","targetId":"6fc2a588-0cc4-fd30-be1c-a3f3b52ba078","targetPort":"Page"},{"sourceId":"c388a816-8daf-0c6a-129a-96c7775d506b","sourcePort":"pageSize","targetId":"6fc2a588-0cc4-fd30-be1c-a3f3b52ba078","targetPort":"PageSize"},{"sourceId":"c388a816-8daf-0c6a-129a-96c7775d506b","sourcePort":"total","targetId":"6fc2a588-0cc4-fd30-be1c-a3f3b52ba078","targetPort":"total"},{"sourceId":"210b3e3a-b1fe-b1da-1058-3c623aede2bd","sourcePort":"failure","targetId":"e129ce2e-bf7a-9255-9066-102fb4e6ec95","targetPort":"Hide"},{"sourceId":"210b3e3a-b1fe-b1da-1058-3c623aede2bd","sourcePort":"success","targetId":"e129ce2e-bf7a-9255-9066-102fb4e6ec95","targetPort":"Hide"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"provinceId","targetId":"fc48e18e-8803-1f0f-c228-697664bcc5be","targetPort":"in-provinceId"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"districtId","targetId":"fc48e18e-8803-1f0f-c228-697664bcc5be","targetPort":"in-districtId"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"wardId","targetId":"fc48e18e-8803-1f0f-c228-697664bcc5be","targetPort":"in-wardId"},{"sourceId":"df4bc0af-0a3a-f6fd-f3c7-9efd899c4f9f","sourcePort":"disasterId","targetId":"fc48e18e-8803-1f0f-c228-697664bcc5be","targetPort":"in-disasterId"}],"ports":[{"name":"Success","type":"signal","plug":"output","index":0},{"name":"Failure","type":"signal","plug":"output","index":1},{"name":"sort","type":"*","group":"Inputs","plug":"input","index":1},{"name":"Data","type":"*","plug":"output","index":2},{"name":"status","type":"*","group":"Inputs","plug":"input","index":2},{"name":"Page","type":"*","plug":"output","index":3},{"name":"provinceId","type":"*","group":"Inputs","plug":"input","index":3},{"name":"PageSize","type":"*","plug":"output","index":4},{"name":"keyword","type":"*","group":"Inputs","plug":"input","index":4},{"name":"total","type":"*","plug":"output","index":5},{"name":"Do","type":{"name":"signal","allowConnectionsOnly":true},"group":"Actions","plug":"input","index":5},{"name":"page","type":"*","group":"Inputs","plug":"input","index":6},{"name":"limit","type":"*","group":"Inputs","plug":"input","index":7},{"name":"Clear","type":"*","plug":"input","index":8},{"name":"type","type":"*","group":"Inputs","plug":"input","index":9},{"name":"districtId","type":"*","group":"Inputs","plug":"input","index":10},{"name":"wardId","type":"*","group":"Inputs","plug":"input","index":11},{"name":"disasterId","type":"*","group":"Inputs","plug":"input","index":12}],"roots":[]},{"name":"/#Logic/GetLocation","nodes":[{"id":"f9150f44-6387-69f5-2438-a4d6f78e4a41","type":"Component Inputs","parameters":{},"ports":[],"children":[]},{"id":"c15dbe30-1ea4-b75a-4306-8a08db9df90b","type":"Component Outputs","parameters":{},"ports":[],"children":[]},{"id":"aa3e3ca3-2643-dc44-6f4a-dcea96534a55","type":"/Components/Show Toast","parameters":{"Type":"Warning","Message":"Chúng tôi cần biết vị trí của bạn để có thể hỗ trợ kịp thời, hãy nhấn đồng ý chia sẻ vị trí."},"ports":[],"children":[]},{"id":"5a6c39c3-1bc9-7dad-181a-0d994f59079b","type":"JavaScriptFunction","parameters":{"functionScript":"navigator.geolocation.getCurrentPosition(async (position) => {\r\n    const { latitude, longitude } = position.coords;\r\n\r\n    if(latitude && longitude) {\r\n        Outputs.lat = latitude;\r\n        Outputs.lng = longitude;\r\n        Outputs.Success();\r\n    }\r\n    else {\r\n        Outputs.Failure();\r\n    }\r\n});"},"ports":[{"name":"out-Success","displayName":"Success","plug":"output","type":"signal","group":"Outputs","index":4},{"name":"out-Failure","displayName":"Failure","plug":"output","type":"signal","group":"Outputs","index":5},{"name":"out-lat","displayName":"lat","plug":"output","type":"*","group":"Outputs","index":6},{"name":"out-lng","displayName":"lng","plug":"output","type":"*","group":"Outputs","index":7}],"children":[]},{"id":"7ff70700-7b99-a206-000e-d8d97422d18b","type":"Model2","parameters":{"modelId":"Location","properties":"lat,lng"},"ports":[],"children":[]}],"connections":[{"sourceId":"5a6c39c3-1bc9-7dad-181a-0d994f59079b","sourcePort":"out-Failure","targetId":"aa3e3ca3-2643-dc44-6f4a-dcea96534a55","targetPort":"Do"},{"sourceId":"5a6c39c3-1bc9-7dad-181a-0d994f59079b","sourcePort":"out-lat","targetId":"7ff70700-7b99-a206-000e-d8d97422d18b","targetPort":"prop-lat"},{"sourceId":"5a6c39c3-1bc9-7dad-181a-0d994f59079b","sourcePort":"out-lng","targetId":"7ff70700-7b99-a206-000e-d8d97422d18b","targetPort":"prop-lng"},{"sourceId":"f9150f44-6387-69f5-2438-a4d6f78e4a41","sourcePort":"Do","targetId":"5a6c39c3-1bc9-7dad-181a-0d994f59079b","targetPort":"run"},{"sourceId":"5a6c39c3-1bc9-7dad-181a-0d994f59079b","sourcePort":"out-Failure","targetId":"c15dbe30-1ea4-b75a-4306-8a08db9df90b","targetPort":"Failure"},{"sourceId":"5a6c39c3-1bc9-7dad-181a-0d994f59079b","sourcePort":"out-Success","targetId":"c15dbe30-1ea4-b75a-4306-8a08db9df90b","targetPort":"Success"},{"sourceId":"7ff70700-7b99-a206-000e-d8d97422d18b","sourcePort":"prop-lat","targetId":"c15dbe30-1ea4-b75a-4306-8a08db9df90b","targetPort":"lat"},{"sourceId":"7ff70700-7b99-a206-000e-d8d97422d18b","sourcePort":"prop-lng","targetId":"c15dbe30-1ea4-b75a-4306-8a08db9df90b","targetPort":"lng"}],"ports":[{"name":"Success","type":"signal","plug":"output","index":0},{"name":"Do","type":{"name":"signal","allowConnectionsOnly":true},"group":"Actions","plug":"input","index":0},{"name":"Failure","type":"signal","plug":"output","index":1},{"name":"lat","type":{"name":"*","allowConnectionsOnly":true},"plug":"output","index":2},{"name":"lng","type":{"name":"*","allowConnectionsOnly":true},"plug":"output","index":3}],"roots":[]}]