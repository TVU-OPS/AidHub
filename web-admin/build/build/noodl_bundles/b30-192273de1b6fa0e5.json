[{"name":"/component/MapboxYeuCau","nodes":[{"id":"d2c16f4a-4a0a-4c24-1f64-1135523ff150","type":"Group","parameters":{"sizeMode":"contentSize","minWidth":{"value":100,"unit":"%"},"minHeight":{"value":100,"unit":"%"},"maxWidth":{"value":100,"unit":"%"},"maxHeight":{"value":100,"unit":"%"}},"ports":[],"children":[{"id":"bf584a2d-13d7-79e4-6e63-3b1a7f7bcbf1","type":"module.inlineHtml","parameters":{"html":"<div id=\"map\" style=\"width: 100%; height: 100%\"></div>\r\n<script>\r\n  // tọa độ giữa tỉnh (các tỉnh đang bị thiên tai)\r\n  function calculateCenter(points) {\r\n    // Kiểm tra xem danh sách tọa độ có rỗng hay không\r\n    if (!points || points.length === 0) {\r\n      return null; // Không có tọa độ nào để tính\r\n    }\r\n\r\n    let totalX = 0,\r\n      totalY = 0;\r\n\r\n    // Duyệt qua danh sách tọa độ và tính tổng\r\n    points.forEach((point) => {\r\n      totalX += point.lng;\r\n      totalY += point.lat;\r\n    });\r\n\r\n    // Tính trung bình cộng\r\n    const centerX = totalX / points.length;\r\n    const centerY = totalY / points.length;\r\n\r\n    // Trả về tọa độ trung tâm\r\n    return { lng: centerX, lat: centerY };\r\n  }\r\n\r\n  function calculateZoom(points) {\r\n    let maxDistance = 0;\r\n    points.forEach((point1) => {\r\n      points.forEach((point2) => {\r\n        const distance = Math.sqrt(\r\n          Math.pow(point1.lat - point2.lat, 2) +\r\n            Math.pow(point1.lng - point2.lng, 2)\r\n        );\r\n        if (distance > maxDistance) maxDistance = distance;\r\n      });\r\n    });\r\n\r\n    // Quy đổi khoảng cách thành mức zoom\r\n    // Bạn có thể điều chỉnh giá trị này dựa trên kích thước bản đồ\r\n    if (maxDistance > 1) return 5; // Zoom out xa hơn nếu khoảng cách lớn\r\n    if (maxDistance > 0.5) return 8; // Trung bình\r\n    return 10; // Zoom gần\r\n  }\r\n\r\n  // Hàm chuẩn hóa chuỗi\r\n  function normalizeString(str) {\r\n    return str\r\n      .replace(/Tỉnh/g, \"\")\r\n      .replace(/Thành phố/g, \"\")\r\n      .trim(); // Xóa khoảng trắng đầu và cuối chuỗi\r\n  }\r\n\r\n  function updatePosition(position) {\r\n    const { latitude, longitude } = position.coords;\r\n    console.log({ latitude, longitude });\r\n    marker.setLngLat([longitude, latitude]);\r\n  }\r\n\r\n  // khai báo\r\n  function createMapbox() {\r\n    mapboxgl.accessToken =\r\n      \"pk.eyJ1IjoiZGhpZXAyMzA3IiwiYSI6ImNtNDRpeDFtejBuNzkycHB6bXp6eWZ1MTQifQ.169cDiC_Q2YWzRBdIxxgPg\";\r\n\r\n    const provinces = localStorage.getItem(\"provinces\")\r\n      ? JSON.parse(localStorage.getItem(\"provinces\"))\r\n      : [];\r\n\r\n    const locations = localStorage.getItem(\"locations\")\r\n      ? JSON.parse(localStorage.getItem(\"locations\"))\r\n      : [];\r\n\r\n    const provinceNames = provinces?.map((province) =>\r\n      normalizeString(province.name)\r\n    );\r\n\r\n    // Lấy vị trí ở giữa các tỉnh\r\n    let center = {\r\n      lng: 108,\r\n      lat: 14,\r\n    };\r\n\r\n    let zoom = 6;\r\n\r\n    if (locations.length > 0) {\r\n      const posList = locations.map((location) => location);\r\n      center = calculateCenter(posList);\r\n      zoom = calculateZoom(posList);\r\n    }\r\n\r\n    // Không sửa\r\n    map = new mapboxgl.Map({\r\n      style: \"mapbox://styles/dhiep2307/cm44mghvy011l01sd5cci6k20\", // stylesheet location\r\n      container: \"map\", // container ID\r\n      center: [center.lng, center.lat], // starting position [lng, lat]. Note that lat must be set between -90 and 90\r\n      zoom: zoom, // starting zoom\r\n    });\r\n\r\n    marker = new mapboxgl.Marker();\r\n\r\n    // Thêm marker\r\n    if (locations.length > 0) {\r\n      locations.map((location) => {\r\n        const marker2 = new mapboxgl.Marker({ color: \"red\" })\r\n          .setLngLat([location.lng, location.lat]) // Vị trí\r\n          .addTo(map); // Thêm vào bản đồ\r\n\r\n        const popup = new mapboxgl.Popup({\r\n          offset: 25,\r\n          closeOnClick: true,\r\n          closeButton: true,\r\n        }).setHTML(\r\n          `<p style=\"font-size: 20px; font-weight: bold\">${location?.description}</p>\r\n            <a style=\"font-size: 16px; display: block; border: 1px solid #000; padding-left: 8px; padding-top: 5px; padding-bottom: 5px; border-radius: 5px; background-color: green; font-weight: bold; color: white\" href=\"tel://${location?.phone}\"> Gọi: ${location?.phone}</a>\r\n            `\r\n        );\r\n\r\n        marker2.setPopup(popup);\r\n      });\r\n    }\r\n\r\n    // Tạo map\r\n    map.on(\"load\", function () {\r\n      map.addSource(\"diaphanhuyen-4apinm\", {\r\n        type: \"vector\",\r\n        url: \"mapbox://dhiep2307.0va1jnhw\",\r\n      });\r\n\r\n      if (provinces.length > 0) {\r\n        map.addLayer({\r\n          id: \"loc-tinh\",\r\n          type: \"fill\",\r\n          source: \"diaphanhuyen-4apinm\",\r\n          \"source-layer\": \"diaphanhuyen-4apinm\",\r\n          layout: {},\r\n          paint: {\r\n            \"fill-color\": \"#ff6666\",\r\n            \"fill-opacity\": 0.2,\r\n          },\r\n          filter: [\"in\", \"Ten_Tinh\", ...provinceNames],\r\n        });\r\n\r\n        provinces.forEach((e) => {\r\n          map.addLayer({\r\n            id: \"text-layer-tinh-\" + e.name,\r\n            type: \"symbol\",\r\n            source: {\r\n              type: \"geojson\",\r\n              data: {\r\n                type: \"FeatureCollection\",\r\n                features: [\r\n                  {\r\n                    type: \"Feature\",\r\n                    geometry: {\r\n                      type: \"Point\",\r\n                      coordinates: [e.location.lng, e.location.lat],\r\n                    },\r\n                    properties: {\r\n                      title: `${e.name}`, // Văn bản sẽ hiển thị\r\n                    },\r\n                  },\r\n                ],\r\n              },\r\n            },\r\n            layout: {\r\n              \"text-field\": [\"get\", \"title\"], // Lấy giá trị từ thuộc tính 'title' để hiển thị\r\n              \"text-size\": [\r\n                \"interpolate\", // Biểu thức interpolate giúp thay đổi kích thước theo zoom\r\n                [\"linear\"], // Mức độ thay đổi là tuyến tính\r\n                [\"zoom\"], // Sử dụng zoom level để điều chỉnh\r\n                5,\r\n                9, // Zoom level 5: 10px (kích thước chữ nhỏ)\r\n                15,\r\n                30, // Zoom level 15: 30px (kích thước chữ lớn)\r\n              ], // Kích thước chữ\r\n              \"text-anchor\": \"center\", // Căn chỉnh chữ theo giữa điểm\r\n              \"text-offset\": [0, 0], // Định vị trí chữ (tùy chọn)\r\n            },\r\n            paint: {\r\n              \"text-color\": \"#186bf0\", // Màu chữ\r\n              \"text-halo-color\": \"#FFFFFF\", // Màu viền chữ\r\n              \"text-halo-width\": 2, // Độ rộng viền chữ\r\n            },\r\n          });\r\n        });\r\n      }\r\n\r\n      // // Add zoom and rotation controls to the map.\r\n      map.addControl(new mapboxgl.NavigationControl());\r\n      map.addControl(new mapboxgl.FullscreenControl());\r\n\r\n      // Không sửa\r\n      //Thêm layer HS, TS\r\n\r\n      map.addLayer({\r\n        id: \"text-layer-truong-sa\",\r\n        type: \"symbol\",\r\n        source: {\r\n          type: \"geojson\",\r\n          data: {\r\n            type: \"FeatureCollection\",\r\n            features: [\r\n              {\r\n                type: \"Feature\",\r\n                geometry: {\r\n                  type: \"Point\",\r\n                  coordinates: [113.81768, 9.46653],\r\n                },\r\n                properties: {\r\n                  title: \"Quần đảo Trường Sa (Việt Nam)\",\r\n                },\r\n              },\r\n            ],\r\n          },\r\n        },\r\n        layout: {\r\n          \"text-field\": [\"get\", \"title\"], // Lấy giá trị từ thuộc tính 'title' để hiển thị\r\n          \"text-size\": [\r\n            \"interpolate\", // Biểu thức interpolate giúp thay đổi kích thước theo zoom\r\n            [\"linear\"], // Mức độ thay đổi là tuyến tính\r\n            [\"zoom\"], // Sử dụng zoom level để điều chỉnh\r\n            5,\r\n            9, // Zoom level 5: 10px (kích thước chữ nhỏ)\r\n            15,\r\n            30, // Zoom level 15: 30px (kích thước chữ lớn)\r\n          ], // Kích thước chữ\r\n          \"text-anchor\": \"center\", // Căn chỉnh chữ theo giữa điểm\r\n          \"text-offset\": [0, 0], // Định vị trí chữ (tùy chọn)\r\n        },\r\n        paint: {\r\n          \"text-color\": \"#186bf0\", // Màu chữ\r\n          \"text-halo-color\": \"#FFFFFF\", // Màu viền chữ\r\n          \"text-halo-width\": 2, // Độ rộng viền chữ\r\n        },\r\n      });\r\n\r\n      map.addLayer({\r\n        id: \"text-layer-hoang-sa\",\r\n        type: \"symbol\",\r\n        source: {\r\n          type: \"geojson\",\r\n          data: {\r\n            type: \"FeatureCollection\",\r\n            features: [\r\n              {\r\n                type: \"Feature\",\r\n                geometry: {\r\n                  type: \"Point\",\r\n                  coordinates: [111.90739, 16.50884],\r\n                },\r\n                properties: {\r\n                  title: \"Quần đảo Hoàng Sa (Việt Nam)\", // Văn bản sẽ hiển thị\r\n                },\r\n              },\r\n            ],\r\n          },\r\n        },\r\n        layout: {\r\n          \"text-field\": [\"get\", \"title\"], // Lấy giá trị từ thuộc tính 'title' để hiển thị\r\n          \"text-size\": [\r\n            \"interpolate\", // Biểu thức interpolate giúp thay đổi kích thước theo zoom\r\n            [\"linear\"], // Mức độ thay đổi là tuyến tính\r\n            [\"zoom\"], // Sử dụng zoom level để điều chỉnh\r\n            5,\r\n            9, // Zoom level 5: 10px (kích thước chữ nhỏ)\r\n            15,\r\n            30, // Zoom level 15: 30px (kích thước chữ lớn)\r\n          ], // Kích thước chữ\r\n          \"text-anchor\": \"center\", // Căn chỉnh chữ theo giữa điểm\r\n          \"text-offset\": [0, 0], // Định vị trí chữ (tùy chọn)\r\n        },\r\n        paint: {\r\n          \"text-color\": \"#186bf0\", // Màu chữ\r\n          \"text-halo-color\": \"#FFFFFF\", // Màu viền chữ\r\n          \"text-halo-width\": 2, // Độ rộng viền chữ\r\n        },\r\n      });\r\n\r\n      map.addLayer({\r\n        id: \"text-layer-bien-dong\",\r\n        type: \"symbol\",\r\n        source: {\r\n          type: \"geojson\",\r\n          data: {\r\n            type: \"FeatureCollection\",\r\n            features: [\r\n              {\r\n                type: \"Feature\",\r\n                geometry: {\r\n                  type: \"Point\",\r\n                  coordinates: [113.23996, 13.84156],\r\n                },\r\n                properties: {\r\n                  title: \"Biển Đông\", // Văn bản sẽ hiển thị\r\n                },\r\n              },\r\n            ],\r\n          },\r\n        },\r\n        layout: {\r\n          \"text-field\": [\"get\", \"title\"], // Lấy giá trị từ thuộc tính 'title' để hiển thị\r\n          \"text-size\": [\r\n            \"interpolate\", // Biểu thức interpolate giúp thay đổi kích thước theo zoom\r\n            [\"linear\"], // Mức độ thay đổi là tuyến tính\r\n            [\"zoom\"], // Sử dụng zoom level để điều chỉnh\r\n            14,\r\n            16, // Zoom level 5: 10px (kích thước chữ nhỏ)\r\n            18,\r\n            30, // Zoom level 15: 30px (kích thước chữ lớn)\r\n          ], // Kích thước chữ\r\n          \"text-anchor\": \"center\", // Căn chỉnh chữ theo giữa điểm\r\n          \"text-offset\": [0, 0], // Định vị trí chữ (tùy chọn)\r\n        },\r\n        paint: {\r\n          \"text-color\": \"#186bf0\", // Màu chữ\r\n          \"text-halo-color\": \"#FFFFFF\", // Màu viền chữ\r\n          \"text-halo-width\": 2, // Độ rộng viền chữ\r\n        },\r\n      });\r\n    });\r\n  }\r\n\r\n  createMapbox();\r\n</script>\r\n","styleCss":"/* background-color: red; */\r\n\r\nwidth: 100%;\r\nheight: 100%;\r\nborder-radius: 12px;\r\noverflow: hidden;","runJs":true},"ports":[],"children":[]}]}],"connections":[],"ports":[],"roots":["d2c16f4a-4a0a-4c24-1f64-1135523ff150"]},{"name":"/#Logic/GetChiTietThienTai","nodes":[{"id":"83155c6b-3946-8d5b-fbc2-3df175154d84","type":"Component Inputs","parameters":{},"ports":[],"children":[]},{"id":"553cfdfb-a313-21f4-5cf2-6afab3353c21","type":"Component Outputs","parameters":{},"ports":[],"children":[]},{"id":"d9168337-a778-6472-6354-febe568bdd7f","type":"REST2","parameters":{"responseScript":"// Add custom code to convert the response content to outputs\n//\n//*Response.status    The status code of the response\n//*Response.content   The content of the response as a javascript\n//                    object.\n//*Response.request   The request object that resulted in the response.\n//\n//*Inputs and *Outputs contain the inputs and outputs of the node.\n\nconst DATA = Response.content;\n\nif(!DATA) return;\n\nOutputs.DATA = Response.content?.data\nOutputs.Results = Response.DATA;","resource":"","requestScript":"//Add custom code to setup the request object before the request\n//is made.\n//\n//*Request.resource     contains the resource path of the request.\n//*Request.method       contains the method, GET, POST, PUT or DELETE.\n//*Request.headers      is a map where you can add additional headers.\n//*Request.parameters   is a map the parameters that will be appended\n//                      to the url.\n//*Request.content      contains the content of the request as a javascript\n//                      object.\n//\nconst tokenInfo = Inputs.token\n\nRequest.headers = {\n    Authorization: `Bearer ${tokenInfo}`,\n}"},"ports":[],"children":[]},{"id":"2a2f2e23-3463-b4ef-dc40-4cc2792ef86f","type":"/#Logic/CurrentUser","parameters":{},"ports":[],"children":[]},{"id":"21c5be55-c027-9afd-490e-cadcc9893505","type":"/#Logic/State API","parameters":{},"ports":[],"children":[]},{"id":"eefc99a5-7d60-4b9e-9087-63a163efc0b3","type":"Expression","parameters":{"expression":"baseApi + '/' + id + '?populate=*'"},"ports":[],"children":[]}],"connections":[{"sourceId":"2a2f2e23-3463-b4ef-dc40-4cc2792ef86f","sourcePort":"token","targetId":"d9168337-a778-6472-6354-febe568bdd7f","targetPort":"in-token"},{"sourceId":"83155c6b-3946-8d5b-fbc2-3df175154d84","sourcePort":"id","targetId":"eefc99a5-7d60-4b9e-9087-63a163efc0b3","targetPort":"id"},{"sourceId":"eefc99a5-7d60-4b9e-9087-63a163efc0b3","sourcePort":"result","targetId":"d9168337-a778-6472-6354-febe568bdd7f","targetPort":"resource"},{"sourceId":"83155c6b-3946-8d5b-fbc2-3df175154d84","sourcePort":"Do","targetId":"d9168337-a778-6472-6354-febe568bdd7f","targetPort":"fetch"},{"sourceId":"d9168337-a778-6472-6354-febe568bdd7f","sourcePort":"out-DATA","targetId":"553cfdfb-a313-21f4-5cf2-6afab3353c21","targetPort":"data"},{"sourceId":"21c5be55-c027-9afd-490e-cadcc9893505","sourcePort":"disasters","targetId":"eefc99a5-7d60-4b9e-9087-63a163efc0b3","targetPort":"baseApi"},{"sourceId":"d9168337-a778-6472-6354-febe568bdd7f","sourcePort":"success","targetId":"553cfdfb-a313-21f4-5cf2-6afab3353c21","targetPort":"Success"},{"sourceId":"d9168337-a778-6472-6354-febe568bdd7f","sourcePort":"failure","targetId":"553cfdfb-a313-21f4-5cf2-6afab3353c21","targetPort":"Failure"}],"ports":[{"name":"Success","type":"signal","plug":"output","index":0},{"name":"Do","type":{"name":"signal","allowConnectionsOnly":true},"group":"Actions","plug":"input","index":0},{"name":"Failure","type":"signal","plug":"output","index":1},{"name":"id","type":{"name":"*","editAsType":"string"},"group":"Parameters","plug":"input","index":1},{"name":"data","type":"*","plug":"output","index":2}],"roots":[]}]