[{"name":"/component/MapboxThienTai","nodes":[{"id":"830194f5-39f8-a904-4a35-a2a31475d893","type":"Group","parameters":{"sizeMode":"contentSize","minWidth":{"value":100,"unit":"%"},"minHeight":{"value":100,"unit":"%"},"maxWidth":{"value":100,"unit":"%"},"maxHeight":{"value":100,"unit":"%"}},"ports":[],"children":[{"id":"895cf3d0-9bc8-02c9-e147-c1e4acae2514","type":"module.inlineHtml","parameters":{"html":"<div id=\"map\" style=\"width: 100%; height: 100%\"></div>\r\n<script>\r\n  // tọa độ giữa tỉnh (các tỉnh đang bị thiên tai)\r\n  function calculateCenter(points) {\r\n    // Kiểm tra xem danh sách tọa độ có rỗng hay không\r\n    if (!points || points.length === 0) {\r\n      return null; // Không có tọa độ nào để tính\r\n    }\r\n\r\n    let totalX = 0,\r\n      totalY = 0;\r\n\r\n    // Duyệt qua danh sách tọa độ và tính tổng\r\n    points.forEach((point) => {\r\n      totalX += point.lng;\r\n      totalY += point.lat;\r\n    });\r\n\r\n    // Tính trung bình cộng\r\n    const centerX = totalX / points.length;\r\n    const centerY = totalY / points.length;\r\n\r\n    // Trả về tọa độ trung tâm\r\n    return { lng: centerX, lat: centerY };\r\n  }\r\n\r\n  function calculateZoom(points) {\r\n    let maxDistance = 0;\r\n    points.forEach((point1) => {\r\n      points.forEach((point2) => {\r\n        const distance = Math.sqrt(\r\n          Math.pow(point1.lat - point2.lat, 2) +\r\n            Math.pow(point1.lng - point2.lng, 2)\r\n        );\r\n        if (distance > maxDistance) maxDistance = distance;\r\n      });\r\n    });\r\n\r\n    // Quy đổi khoảng cách thành mức zoom\r\n    // Bạn có thể điều chỉnh giá trị này dựa trên kích thước bản đồ\r\n    if (maxDistance > 1) return 5; // Zoom out xa hơn nếu khoảng cách lớn\r\n    if (maxDistance > 0.5) return 8; // Trung bình\r\n    return 10; // Zoom gần\r\n  }\r\n\r\n  // Hàm chuẩn hóa chuỗi\r\n  function normalizeString(str) {\r\n    return str\r\n      .replace(/Tỉnh/g, \"\")\r\n      .replace(/Thành phố/g, \"\")\r\n      .trim(); // Xóa khoảng trắng đầu và cuối chuỗi\r\n  }\r\n\r\n  function updatePosition(position) {\r\n    const { latitude, longitude } = position.coords;\r\n    console.log({ latitude, longitude });\r\n    marker.setLngLat([longitude, latitude]);\r\n  }\r\n\r\n  // khai báo\r\n  function createMapbox() {\r\n    mapboxgl.accessToken =\r\n      \"pk.eyJ1IjoiZGhpZXAyMzA3IiwiYSI6ImNtNDRpeDFtejBuNzkycHB6bXp6eWZ1MTQifQ.169cDiC_Q2YWzRBdIxxgPg\";\r\n\r\n    // const provinces = [\r\n    //   {\r\n    //     name: \"Thành phố Hà Nội\",\r\n    //     disasters: \"Lũ lớn\",\r\n    //     location: { lng: 105.854041, lat: 21.0283334 },\r\n    //   },\r\n    //   {\r\n    //     name: \"Tỉnh Hoà Bình\",\r\n    //     disasters: \"Lũ lớn\",\r\n    //     location: { lng: 105.3759952, lat: 20.6763365 },\r\n    //   },\r\n    //   {\r\n    //     name: \"Tỉnh Cao Bằng\",\r\n    //     disasters: \"Lũ lớn\",\r\n    //     location: { lng: 106.1060926, lat: 22.7426936 },\r\n    //   },\r\n    //   {\r\n    //     name: \"Tỉnh Bến Tre\",\r\n    //     disasters: \"Mưa đom đóm\",\r\n    //     location: { lng: 106.4811559, lat: 10.1093637 },\r\n    //   },\r\n    //   {\r\n    //     name: \"Tỉnh Vĩnh Long\",\r\n    //     disasters: \"Động đất\",\r\n    //     location: { lng: 105.9669665, lat: 10.1203043 },\r\n    //   },\r\n    //   {\r\n    //     name: \"Thành phố Cần Thơ\",\r\n    //     disasters: \"Động đất\",\r\n    //     location: { lng: 105.7875821, lat: 10.0364634 },\r\n    //   },\r\n    // ];\r\n\r\n    const provinces = localStorage.getItem(\"provinces\")\r\n      ? JSON.parse(localStorage.getItem(\"provinces\"))\r\n      : [];\r\n\r\n    const provinceNames = provinces?.map((province) =>\r\n      normalizeString(province.name)\r\n    );\r\n\r\n    // Lấy vị trí ở giữa các tỉnh\r\n    let center = {\r\n      lng: 108,\r\n      lat: 14,\r\n    };\r\n\r\n    let zoom = 6;\r\n\r\n    if (provinces.length > 0) {\r\n      const posList = provinces.map((province) => province.location);\r\n      center = calculateCenter(posList);\r\n      zoom = calculateZoom(posList);\r\n    }\r\n\r\n    // Không sửa\r\n    map = new mapboxgl.Map({\r\n      style: \"mapbox://styles/dhiep2307/cm44mghvy011l01sd5cci6k20\", // stylesheet location\r\n      container: \"map\", // container ID\r\n      center: [center.lng, center.lat], // starting position [lng, lat]. Note that lat must be set between -90 and 90\r\n      zoom: zoom, // starting zoom\r\n    });\r\n\r\n    marker = new mapboxgl.Marker();\r\n\r\n    map.on(\"load\", function () {\r\n      map.addSource(\"diaphanhuyen-4apinm\", {\r\n        type: \"vector\",\r\n        url: \"mapbox://dhiep2307.0va1jnhw\",\r\n      });\r\n\r\n      if (provinces.length > 0) {\r\n        map.addLayer({\r\n          id: \"loc-tinh\",\r\n          type: \"fill\",\r\n          source: \"diaphanhuyen-4apinm\",\r\n          \"source-layer\": \"diaphanhuyen-4apinm\",\r\n          layout: {},\r\n          paint: {\r\n            \"fill-color\": \"#ff6666\",\r\n            \"fill-opacity\": 0.2,\r\n          },\r\n          filter: [\"in\", \"Ten_Tinh\", ...provinceNames],\r\n        });\r\n\r\n        provinces.forEach((e) => {\r\n          map.addLayer({\r\n            id: \"text-layer-tinh-\" + e.name,\r\n            type: \"symbol\",\r\n            source: {\r\n              type: \"geojson\",\r\n              data: {\r\n                type: \"FeatureCollection\",\r\n                features: [\r\n                  {\r\n                    type: \"Feature\",\r\n                    geometry: {\r\n                      type: \"Point\",\r\n                      coordinates: [e.location.lng, e.location.lat],\r\n                    },\r\n                    properties: {\r\n                      title: `${e.name}`, // Văn bản sẽ hiển thị\r\n                    },\r\n                  },\r\n                ],\r\n              },\r\n            },\r\n            layout: {\r\n              \"text-field\": [\"get\", \"title\"], // Lấy giá trị từ thuộc tính 'title' để hiển thị\r\n              \"text-size\": [\r\n                \"interpolate\", // Biểu thức interpolate giúp thay đổi kích thước theo zoom\r\n                [\"linear\"], // Mức độ thay đổi là tuyến tính\r\n                [\"zoom\"], // Sử dụng zoom level để điều chỉnh\r\n                5,\r\n                9, // Zoom level 5: 10px (kích thước chữ nhỏ)\r\n                15,\r\n                30, // Zoom level 15: 30px (kích thước chữ lớn)\r\n              ], // Kích thước chữ\r\n              \"text-anchor\": \"center\", // Căn chỉnh chữ theo giữa điểm\r\n              \"text-offset\": [0, 0], // Định vị trí chữ (tùy chọn)\r\n            },\r\n            paint: {\r\n              \"text-color\": \"#186bf0\", // Màu chữ\r\n              \"text-halo-color\": \"#FFFFFF\", // Màu viền chữ\r\n              \"text-halo-width\": 2, // Độ rộng viền chữ\r\n            },\r\n          });\r\n        });\r\n      }\r\n\r\n      // // Add zoom and rotation controls to the map.\r\n      map.addControl(new mapboxgl.NavigationControl());\r\n      map.addControl(new mapboxgl.FullscreenControl());\r\n\r\n      // Không sửa\r\n      //Thêm layer HS, TS\r\n\r\n      map.addLayer({\r\n        id: \"text-layer-truong-sa\",\r\n        type: \"symbol\",\r\n        source: {\r\n          type: \"geojson\",\r\n          data: {\r\n            type: \"FeatureCollection\",\r\n            features: [\r\n              {\r\n                type: \"Feature\",\r\n                geometry: {\r\n                  type: \"Point\",\r\n                  coordinates: [113.81768, 9.46653],\r\n                },\r\n                properties: {\r\n                  title: \"Quần đảo Trường Sa (Việt Nam)\",\r\n                },\r\n              },\r\n            ],\r\n          },\r\n        },\r\n        layout: {\r\n          \"text-field\": [\"get\", \"title\"], // Lấy giá trị từ thuộc tính 'title' để hiển thị\r\n          \"text-size\": [\r\n            \"interpolate\", // Biểu thức interpolate giúp thay đổi kích thước theo zoom\r\n            [\"linear\"], // Mức độ thay đổi là tuyến tính\r\n            [\"zoom\"], // Sử dụng zoom level để điều chỉnh\r\n            5,\r\n            9, // Zoom level 5: 10px (kích thước chữ nhỏ)\r\n            15,\r\n            30, // Zoom level 15: 30px (kích thước chữ lớn)\r\n          ], // Kích thước chữ\r\n          \"text-anchor\": \"center\", // Căn chỉnh chữ theo giữa điểm\r\n          \"text-offset\": [0, 0], // Định vị trí chữ (tùy chọn)\r\n        },\r\n        paint: {\r\n          \"text-color\": \"#186bf0\", // Màu chữ\r\n          \"text-halo-color\": \"#FFFFFF\", // Màu viền chữ\r\n          \"text-halo-width\": 2, // Độ rộng viền chữ\r\n        },\r\n      });\r\n\r\n      map.addLayer({\r\n        id: \"text-layer-hoang-sa\",\r\n        type: \"symbol\",\r\n        source: {\r\n          type: \"geojson\",\r\n          data: {\r\n            type: \"FeatureCollection\",\r\n            features: [\r\n              {\r\n                type: \"Feature\",\r\n                geometry: {\r\n                  type: \"Point\",\r\n                  coordinates: [111.90739, 16.50884],\r\n                },\r\n                properties: {\r\n                  title: \"Quần đảo Hoàng Sa (Việt Nam)\", // Văn bản sẽ hiển thị\r\n                },\r\n              },\r\n            ],\r\n          },\r\n        },\r\n        layout: {\r\n          \"text-field\": [\"get\", \"title\"], // Lấy giá trị từ thuộc tính 'title' để hiển thị\r\n          \"text-size\": [\r\n            \"interpolate\", // Biểu thức interpolate giúp thay đổi kích thước theo zoom\r\n            [\"linear\"], // Mức độ thay đổi là tuyến tính\r\n            [\"zoom\"], // Sử dụng zoom level để điều chỉnh\r\n            5,\r\n            9, // Zoom level 5: 10px (kích thước chữ nhỏ)\r\n            15,\r\n            30, // Zoom level 15: 30px (kích thước chữ lớn)\r\n          ], // Kích thước chữ\r\n          \"text-anchor\": \"center\", // Căn chỉnh chữ theo giữa điểm\r\n          \"text-offset\": [0, 0], // Định vị trí chữ (tùy chọn)\r\n        },\r\n        paint: {\r\n          \"text-color\": \"#186bf0\", // Màu chữ\r\n          \"text-halo-color\": \"#FFFFFF\", // Màu viền chữ\r\n          \"text-halo-width\": 2, // Độ rộng viền chữ\r\n        },\r\n      });\r\n\r\n      map.addLayer({\r\n        id: \"text-layer-bien-dong\",\r\n        type: \"symbol\",\r\n        source: {\r\n          type: \"geojson\",\r\n          data: {\r\n            type: \"FeatureCollection\",\r\n            features: [\r\n              {\r\n                type: \"Feature\",\r\n                geometry: {\r\n                  type: \"Point\",\r\n                  coordinates: [113.23996, 13.84156],\r\n                },\r\n                properties: {\r\n                  title: \"Biển Đông\", // Văn bản sẽ hiển thị\r\n                },\r\n              },\r\n            ],\r\n          },\r\n        },\r\n        layout: {\r\n          \"text-field\": [\"get\", \"title\"], // Lấy giá trị từ thuộc tính 'title' để hiển thị\r\n          \"text-size\": [\r\n            \"interpolate\", // Biểu thức interpolate giúp thay đổi kích thước theo zoom\r\n            [\"linear\"], // Mức độ thay đổi là tuyến tính\r\n            [\"zoom\"], // Sử dụng zoom level để điều chỉnh\r\n            14,\r\n            16, // Zoom level 5: 10px (kích thước chữ nhỏ)\r\n            18,\r\n            30, // Zoom level 15: 30px (kích thước chữ lớn)\r\n          ], // Kích thước chữ\r\n          \"text-anchor\": \"center\", // Căn chỉnh chữ theo giữa điểm\r\n          \"text-offset\": [0, 0], // Định vị trí chữ (tùy chọn)\r\n        },\r\n        paint: {\r\n          \"text-color\": \"#186bf0\", // Màu chữ\r\n          \"text-halo-color\": \"#FFFFFF\", // Màu viền chữ\r\n          \"text-halo-width\": 2, // Độ rộng viền chữ\r\n        },\r\n      });\r\n    });\r\n  }\r\n\r\n  createMapbox();\r\n</script>\r\n","styleCss":"/* background-color: red; */\r\n\r\nwidth: 100%;\r\nheight: 100%;","runJs":true},"ports":[],"children":[]}]}],"connections":[],"ports":[],"roots":["830194f5-39f8-a904-4a35-a2a31475d893"]}]